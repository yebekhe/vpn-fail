<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VPN FAIL - Proxy Configurations</title>
    <!-- Add favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.png">
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="VPN FAIL CONFIGs">
    <meta name="twitter:description" content="Browse and copy VPN configurations easily.">
    <meta name="twitter:image" content="https://raw.githubusercontent.com/yebekhe/vpn-fail/main/logo.png">
    <meta name="twitter:site" content="@yebekhe">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Flag Icons -->
    <link href="https://cdn.jsdelivr.net/npm/flag-icons/css/flag-icons.min.css" rel="stylesheet">
    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#121212',
                            card: '#1e1e1e',
                            secondary: '#252525',
                            border: '#333333',
                            text: '#e0e0e0',
                            muted: '#b0b0b0'
                        },
                        accent: {
                            DEFAULT: '#bb86fc',
                            hover: '#9965f4'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'bounce-in': 'bounceIn 0.5s ease-out'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        bounceIn: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '50%': { transform: 'scale(1.05)' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer components {
            .btn {
                @apply flex items-center justify-center gap-2 bg-accent text-dark-bg font-medium py-3 px-4 rounded-lg transition-all duration-300 hover:bg-accent-hover hover:shadow-lg hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-opacity-50;
            }
            .btn-sm {
                @apply py-2 px-3 text-sm;
            }
            .btn-icon {
                @apply p-2 rounded-lg;
            }
            .card {
                @apply bg-dark-card rounded-xl p-5 mb-4 border border-dark-border shadow-lg;
            }
            .input-field {
                @apply w-full bg-dark-secondary border border-dark-border rounded-lg px-4 py-3 text-dark-text placeholder-dark-muted focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent transition-colors;
            }
            .tab {
                @apply px-4 py-2 rounded-lg transition-colors bg-dark-secondary text-dark-muted hover:text-dark-text;
            }
            .tab-active {
                @apply bg-accent text-dark-bg;
            }
        }
    </style>
</head>
<body class="bg-dark-bg text-dark-text font-sans min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header Section -->
        <header class="text-center mb-10 animate-fade-in">
            <div class="flex justify-center mb-4">
                <img src="logo.png" alt="VPN FAIL Logo" class="h-20 w-20 rounded-full shadow-xl">
            </div>
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-accent to-purple-400 bg-clip-text text-transparent">VPN FAIL</h1>
            <p class="text-dark-muted max-w-md mx-auto">Browse and copy VPN configurations easily. All configs are tested and updated regularly.</p>
            
            <!-- Main Action Button -->
            <div class="mt-6">
                <button id="copySubscriptionBtn" class="btn group">
                    <span class="material-icons">content_copy</span>
                    <span>Copy Full Subscription Link</span>
                    <span class="material-icons opacity-0 group-hover:opacity-100 transition-opacity duration-300">open_in_new</span>
                </button>
            </div>
        </header>

        <!-- Stats Section -->
        <div id="statsSection" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 hidden">
            <div class="card text-center animate-bounce-in">
                <div class="text-3xl font-bold text-accent" id="totalConfigs">0</div>
                <div class="text-dark-muted">Total Configs</div>
            </div>
            <div class="card text-center animate-bounce-in" style="animation-delay: 0.1s">
                <div class="text-3xl font-bold text-accent" id="totalCountries">0</div>
                <div class="text-dark-muted">Countries</div>
            </div>
            <div class="card text-center animate-bounce-in" style="animation-delay: 0.2s">
                <div class="text-3xl font-bold text-accent" id="lastUpdated">--</div>
                <div class="text-dark-muted">Last Updated</div>
            </div>
        </div>

        <!-- Category Selector -->
        <div id="categorySection" class="card mb-6 hidden animate-fade-in">
            <h3 class="text-lg font-semibold mb-3">View Configurations By:</h3>
            <div class="flex flex-wrap gap-2">
                <button id="categoryAll" class="tab tab-active" data-category="all">
                    <span class="material-icons text-lg">view_list</span>
                    All Configs
                </button>
                <button id="categoryType" class="tab" data-category="type">
                    <span class="material-icons text-lg">category</span>
                    By Type
                </button>
                <button id="categoryCountry" class="tab" data-category="country">
                    <span class="material-icons text-lg">public</span>
                    By Country
                </button>
                <button id="categoryTypeCountry" class="tab" data-category="type-country">
                    <span class="material-icons text-lg">filter_list</span>
                    By Type & Country
                </button>
            </div>
        </div>

        <!-- Filter Section -->
        <div id="filterSection" class="card mb-6 hidden animate-fade-in">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-medium mb-1">Search by name or country</label>
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="Search configurations..." class="input-field pl-10">
                        <span class="material-icons absolute left-3 top-3.5 text-dark-muted">search</span>
                    </div>
                </div>
                <div class="w-full md:w-48">
                    <label class="block text-sm font-medium mb-1">Filter by type</label>
                    <select id="typeFilter" class="input-field">
                        <option value="all">All Types</option>
                        <option value="vmess">VMess</option>
                        <option value="vless">VLESS</option>
                        <option value="trojan">Trojan</option>
                        <option value="ss">Shadowsocks</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Secondary Tabs (for countries or types) -->
        <div id="secondaryTabs" class="flex flex-wrap gap-2 mb-6 overflow-x-auto pb-2 hidden"></div>

        <!-- Loading State -->
        <div id="loadingState" class="flex flex-col items-center justify-center py-16">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-accent mb-4"></div>
            <p class="text-dark-muted">Loading configurations...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="card text-center py-10 hidden">
            <span class="material-icons text-red-500 text-5xl mb-4">error_outline</span>
            <h3 class="text-xl font-semibold mb-2">Failed to load configurations</h3>
            <p class="text-dark-muted mb-4">Please try again later or check your connection.</p>
            <button onclick="location.reload()" class="btn">
                <span class="material-icons">refresh</span>
                Reload Page
            </button>
        </div>

        <!-- Configurations Container -->
        <div id="configsContainer" class="hidden">
            <!-- Config cards will be inserted here -->
            <div id="configsList"></div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 pt-6 border-t border-dark-border text-center text-dark-muted text-sm">
            <div class="flex flex-col md:flex-row justify-center items-center gap-4 mb-4">
                <a href="https://github.com/yebekhe/vpn-fail" target="_blank" class="flex items-center gap-1 hover:text-accent transition-colors">
                    <span class="material-icons text-lg">code</span>
                    GitHub Repository
                </a>
                <a href="https://t.me/yebekhe" target="_blank" class="flex items-center gap-1 hover:text-accent transition-colors">
                    <span class="material-icons text-lg">send</span>
                    Telegram Channel
                </a>
                <a href="https://twitter.com/yebekhe" target="_blank" class="flex items-center gap-1 hover:text-accent transition-colors">
                    <span class="material-icons text-lg">alternate_email</span>
                    Follow on Twitter
                </a>
            </div>
            <p>© 2023 VPN FAIL. All rights reserved.</p>
        </footer>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-accent text-dark-bg px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-2">
        <span class="material-icons">check_circle</span>
        <span id="toastMessage">Copied to clipboard!</span>
    </div>

    <script>
        // Subscription link
        const subscriptionLink = "https://raw.githubusercontent.com/yebekhe/vpn-fail/main/sub-link";
        
        // DOM elements
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const configsContainer = document.getElementById('configsContainer');
        const statsSection = document.getElementById('statsSection');
        const categorySection = document.getElementById('categorySection');
        const filterSection = document.getElementById('filterSection');
        const secondaryTabs = document.getElementById('secondaryTabs');
        const configsList = document.getElementById('configsList');
        const searchInput = document.getElementById('searchInput');
        const typeFilter = document.getElementById('typeFilter');
        const totalConfigsEl = document.getElementById('totalConfigs');
        const totalCountriesEl = document.getElementById('totalCountries');
        const lastUpdatedEl = document.getElementById('lastUpdated');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        
        // State
        let apiData = [];
        let countryCodes = {};
        let currentCategory = 'all';
        let activeType = null;
        let activeCountry = 'all';
        let groupedConfigs = {};
        let groupedByType = {};
        let groupedByTypeCountry = {};
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Fetch data
                const [data, countries] = await Promise.all([
                    fetch('api').then(response => response.json()),
                    fetch('countries.lock').then(response => response.json())
                ]);
                
                apiData = data;
                countryCodes = countries;
                
                // Process data
                processConfigs(data);
                
                // Show UI
                loadingState.classList.add('hidden');
                configsContainer.classList.remove('hidden');
                statsSection.classList.remove('hidden');
                categorySection.classList.remove('hidden');
                filterSection.classList.remove('hidden');
                
                // Setup event listeners
                setupEventListeners();
                
                // Display initial category
                switchCategory('all');
                
            } catch (error) {
                console.error('Error fetching data:', error);
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
            }
        });
        
        // Process configurations
        function processConfigs(data) {
            // Group configurations by country
            groupedConfigs = data.reduce((acc, config) => {
                const country = config.country_text || 'Unknown';
                if (!acc[country]) {
                    acc[country] = [];
                }
                acc[country].push(config);
                return acc;
            }, {});
            
            // Group configurations by type
            groupedByType = data.reduce((acc, config) => {
                const type = config.enriched_data?.type || 'unknown';
                if (!acc[type]) {
                    acc[type] = [];
                }
                acc[type].push(config);
                return acc;
            }, {});
            
            // Group configurations by type and country
            groupedByTypeCountry = data.reduce((acc, config) => {
                const type = config.enriched_data?.type || 'unknown';
                const country = config.country_text || 'Unknown';
                
                if (!acc[type]) {
                    acc[type] = {};
                }
                if (!acc[type][country]) {
                    acc[type][country] = [];
                }
                acc[type][country].push(config);
                return acc;
            }, {});
            
            // Update stats
            totalConfigsEl.textContent = data.length;
            totalCountriesEl.textContent = Object.keys(groupedConfigs).length;
            lastUpdatedEl.textContent = new Date().toLocaleDateString();
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Copy subscription link
            document.getElementById('copySubscriptionBtn').addEventListener('click', copySubscriptionLink);
            
            // Category buttons
            document.getElementById('categoryAll').addEventListener('click', () => switchCategory('all'));
            document.getElementById('categoryType').addEventListener('click', () => switchCategory('type'));
            document.getElementById('categoryCountry').addEventListener('click', () => switchCategory('country'));
            document.getElementById('categoryTypeCountry').addEventListener('click', () => switchCategory('type-country'));
            
            // Search input
            searchInput.addEventListener('input', filterAndDisplayConfigs);
            
            // Type filter
            typeFilter.addEventListener('change', filterAndDisplayConfigs);
        }
        
        // Switch category
        function switchCategory(category) {
            currentCategory = category;
            
            // Update category tab styles
            document.querySelectorAll('#categorySection .tab').forEach(tab => {
                if (tab.dataset.category === category) {
                    tab.classList.add('tab-active');
                } else {
                    tab.classList.remove('tab-active');
                }
            });
            
            // Reset filters
            searchInput.value = '';
            typeFilter.value = 'all';
            activeType = null;
            activeCountry = 'all';
            
            // Clear secondary tabs
            secondaryTabs.innerHTML = '';
            secondaryTabs.classList.add('hidden');
            
            // Display configs based on category
            switch (category) {
                case 'all':
                    displayAllConfigs();
                    break;
                case 'type':
                    displayByType();
                    break;
                case 'country':
                    displayByCountry();
                    break;
                case 'type-country':
                    displayByTypeCountry();
                    break;
            }
        }
        
        // Display all configs
        function displayAllConfigs() {
            filterSection.classList.remove('hidden');
            filterAndDisplayConfigs();
        }
        
        // Display configs by type
        function displayByType() {
            filterSection.classList.remove('hidden');
            secondaryTabs.classList.remove('hidden');
            
            // Create type tabs
            secondaryTabs.innerHTML = '';
            
            // All types tab
            const allTypesTab = document.createElement('button');
            allTypesTab.className = 'tab tab-active';
            allTypesTab.innerHTML = '<span class="material-icons text-lg">apps</span> All Types';
            allTypesTab.onclick = () => selectType(null);
            secondaryTabs.appendChild(allTypesTab);
            
            // Type tabs
            Object.keys(groupedByType).forEach(type => {
                const tab = document.createElement('button');
                tab.className = 'tab';
                tab.innerHTML = `
                    <span class="material-icons text-lg">${getTypeIcon(type)}</span>
                    ${type.toUpperCase()}
                    <span class="bg-dark-secondary px-2 py-1 rounded-full text-xs ml-1">${groupedByType[type].length}</span>
                `;
                tab.onclick = () => selectType(type);
                secondaryTabs.appendChild(tab);
            });
            
            // Initially show all types
            selectType(null);
        }
        
        // Display configs by country
        function displayByCountry() {
            filterSection.classList.remove('hidden');
            secondaryTabs.classList.remove('hidden');
            
            // Create country tabs
            secondaryTabs.innerHTML = '';
            
            // All countries tab
            const allCountriesTab = document.createElement('button');
            allCountriesTab.className = 'tab tab-active';
            allCountriesTab.innerHTML = '<span class="material-icons text-lg">public</span> All Countries';
            allCountriesTab.onclick = () => selectCountry(null);
            secondaryTabs.appendChild(allCountriesTab);
            
            // Country tabs
            Object.keys(groupedConfigs).forEach(country => {
                const flagCode = getFlagCode(country);
                const countryEmoji = getCountryEmoji(flagCode);
                const tab = document.createElement('button');
                tab.className = 'tab';
                tab.innerHTML = `
                    <span class="text-lg">${countryEmoji}</span>
                    ${country}
                    <span class="bg-dark-secondary px-2 py-1 rounded-full text-xs ml-1">${groupedConfigs[country].length}</span>
                `;
                tab.onclick = () => selectCountry(country);
                secondaryTabs.appendChild(tab);
            });
            
            // Initially show all countries
            selectCountry(null);
        }
        
        // Display configs by type and country
        function displayByTypeCountry() {
            filterSection.classList.add('hidden');
            secondaryTabs.classList.remove('hidden');
            
            // Create type tabs
            secondaryTabs.innerHTML = '';
            
            // Type tabs
            Object.keys(groupedByTypeCountry).forEach(type => {
                const tab = document.createElement('button');
                tab.className = 'tab';
                tab.innerHTML = `
                    <span class="material-icons text-lg">${getTypeIcon(type)}</span>
                    ${type.toUpperCase()}
                `;
                tab.onclick = () => selectTypeForTypeCountry(type);
                secondaryTabs.appendChild(tab);
            });
            
            // Initially select the first type
            if (Object.keys(groupedByTypeCountry).length > 0) {
                selectTypeForTypeCountry(Object.keys(groupedByTypeCountry)[0]);
            }
        }
        
        // Select type for type-country view
        function selectTypeForTypeCountry(type) {
            activeType = type;
            
            // Update type tab styles
            const typeTabs = secondaryTabs.querySelectorAll('.tab');
            typeTabs.forEach(tab => {
                if (tab.textContent.toLowerCase().includes(type.toLowerCase())) {
                    tab.classList.add('tab-active');
                } else {
                    tab.classList.remove('tab-active');
                }
            });
            
            // Create country tabs for the selected type
            const countriesForType = groupedByTypeCountry[type] || {};
            
            // Create a new container for country tabs
            const countryTabsContainer = document.createElement('div');
            countryTabsContainer.className = 'flex flex-wrap gap-2 mb-6 overflow-x-auto pb-2';
            
            // All countries tab for this type
            const allCountriesTab = document.createElement('button');
            allCountriesTab.className = 'tab tab-active';
            allCountriesTab.innerHTML = '<span class="material-icons text-lg">public</span> All Countries';
            allCountriesTab.onclick = () => selectCountryForTypeCountry(null);
            countryTabsContainer.appendChild(allCountriesTab);
            
            // Country tabs for this type
            Object.keys(countriesForType).forEach(country => {
                const flagCode = getFlagCode(country);
                const countryEmoji = getCountryEmoji(flagCode);
                const tab = document.createElement('button');
                tab.className = 'tab';
                tab.innerHTML = `
                    <span class="text-lg">${countryEmoji}</span>
                    ${country}
                    <span class="bg-dark-secondary px-2 py-1 rounded-full text-xs ml-1">${countriesForType[country].length}</span>
                `;
                tab.onclick = () => selectCountryForTypeCountry(country);
                countryTabsContainer.appendChild(tab);
            });
            
            // Replace the current secondary tabs with country tabs
            configsList.innerHTML = '';
            configsList.appendChild(countryTabsContainer);
            
            // Initially show all countries for this type
            selectCountryForTypeCountry(null);
        }
        
        // Select country for type-country view
        function selectCountryForTypeCountry(country) {
            activeCountry = country;
            
            // Update country tab styles
            const countryTabs = configsList.querySelector('.flex');
            if (countryTabs) {
                const tabs = countryTabs.querySelectorAll('.tab');
                tabs.forEach(tab => {
                    if (country === null && tab.textContent.includes('All Countries')) {
                        tab.classList.add('tab-active');
                    } else if (country !== null && tab.textContent.includes(country)) {
                        tab.classList.add('tab-active');
                    } else {
                        tab.classList.remove('tab-active');
                    }
                });
            }
            
            // Display configs for the selected type and country
            displayConfigsForTypeCountry();
        }
        
        // Display configs for type and country
        function displayConfigsForTypeCountry() {
            const configs = activeType && activeCountry
                ? (groupedByTypeCountry[activeType]?.[activeCountry] || [])
                : (activeType
                    ? Object.values(groupedByTypeCountry[activeType] || {}).flat()
                    : []);
            
            configsList.innerHTML = '';
            
            if (configs.length === 0) {
                configsList.innerHTML = `
                    <div class="card text-center py-10">
                        <span class="material-icons text-5xl text-dark-muted mb-4">search_off</span>
                        <h3 class="text-xl font-semibold mb-2">No configurations found</h3>
                        <p class="text-dark-muted">Try selecting a different type or country.</p>
                    </div>
                `;
                return;
            }
            
            // Create a card for the type and country
            const card = document.createElement('div');
            card.className = 'card animate-fade-in';
            
            const title = activeType && activeCountry
                ? `${activeType.toUpperCase()} in ${activeCountry}`
                : activeType
                    ? `All ${activeType.toUpperCase()} Configurations`
                    : 'All Configurations';
            
            card.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <h2 class="text-xl font-bold">${title}</h2>
                        <span class="bg-dark-secondary px-2 py-1 rounded-full text-xs">${configs.length} configs</span>
                    </div>
                    <button class="btn-sm" onclick="copyConfigsForTypeCountry()">
                        <span class="material-icons">content_copy</span>
                        Copy All
                    </button>
                </div>
                <div class="space-y-3">
                    ${configs.map(config => createConfigItem(config)).join('')}
                </div>
            `;
            
            configsList.appendChild(card);
        }
        
        // Copy configs for type and country
        function copyConfigsForTypeCountry() {
            let configs = [];
            
            if (activeType && activeCountry) {
                configs = groupedByTypeCountry[activeType]?.[activeCountry] || [];
            } else if (activeType) {
                configs = Object.values(groupedByTypeCountry[activeType] || {}).flat();
            } else {
                configs = apiData;
            }
            
            const configTexts = configs.map(config => config.input_value).join('\n');
            
            navigator.clipboard.writeText(configTexts).then(() => {
                showToast(`Copied ${configs.length} configurations!`);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy configurations', 'error');
            });
        }
        
        // Select type
        function selectType(type) {
            activeType = type;
            
            // Update type tab styles
            const typeTabs = secondaryTabs.querySelectorAll('.tab');
            typeTabs.forEach(tab => {
                if (type === null && tab.textContent.includes('All Types')) {
                    tab.classList.add('tab-active');
                } else if (type !== null && tab.textContent.toLowerCase().includes(type.toLowerCase())) {
                    tab.classList.add('tab-active');
                } else {
                    tab.classList.remove('tab-active');
                }
            });
            
            // Display configs for the selected type
            displayConfigsForType();
        }
        
        // Display configs for type
        function displayConfigsForType() {
            const configs = activeType ? groupedByType[activeType] || [] : apiData;
            
            configsList.innerHTML = '';
            
            if (configs.length === 0) {
                configsList.innerHTML = `
                    <div class="card text-center py-10">
                        <span class="material-icons text-5xl text-dark-muted mb-4">search_off</span>
                        <h3 class="text-xl font-semibold mb-2">No configurations found</h3>
                        <p class="text-dark-muted">Try selecting a different type.</p>
                    </div>
                `;
                return;
            }
            
            // Create a card for the type
            const card = document.createElement('div');
            card.className = 'card animate-fade-in';
            
            const title = activeType ? `${activeType.toUpperCase()} Configurations` : 'All Configurations';
            
            card.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <h2 class="text-xl font-bold">${title}</h2>
                        <span class="bg-dark-secondary px-2 py-1 rounded-full text-xs">${configs.length} configs</span>
                    </div>
                    <button class="btn-sm" onclick="copyConfigsForType()">
                        <span class="material-icons">content_copy</span>
                        Copy All
                    </button>
                </div>
                <div class="space-y-3">
                    ${configs.map(config => createConfigItem(config)).join('')}
                </div>
            `;
            
            configsList.appendChild(card);
        }
        
        // Copy configs for type
        function copyConfigsForType() {
            const configs = activeType ? groupedByType[activeType] || [] : apiData;
            const configTexts = configs.map(config => config.input_value).join('\n');
            
            navigator.clipboard.writeText(configTexts).then(() => {
                showToast(`Copied ${configs.length} ${activeType ? activeType.toUpperCase() : ''} configurations!`);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy configurations', 'error');
            });
        }
        
        // Select country
        function selectCountry(country) {
            activeCountry = country;
            
            // Update country tab styles
            const countryTabs = secondaryTabs.querySelectorAll('.tab');
            countryTabs.forEach(tab => {
                if (country === null && tab.textContent.includes('All Countries')) {
                    tab.classList.add('tab-active');
                } else if (country !== null && tab.textContent.includes(country)) {
                    tab.classList.add('tab-active');
                } else {
                    tab.classList.remove('tab-active');
                }
            });
            
            // Display configs for the selected country
            displayConfigsForCountry();
        }
        
        // Display configs for country
        function displayConfigsForCountry() {
            const configs = activeCountry ? groupedConfigs[activeCountry] || [] : apiData;
            
            configsList.innerHTML = '';
            
            if (configs.length === 0) {
                configsList.innerHTML = `
                    <div class="card text-center py-10">
                        <span class="material-icons text-5xl text-dark-muted mb-4">search_off</span>
                        <h3 class="text-xl font-semibold mb-2">No configurations found</h3>
                        <p class="text-dark-muted">Try selecting a different country.</p>
                    </div>
                `;
                return;
            }
            
            // Create a card for the country
            const card = document.createElement('div');
            card.className = 'card animate-fade-in';
            
            const title = activeCountry ? `${activeCountry} Configurations` : 'All Configurations';
            const flagCode = activeCountry ? getFlagCode(activeCountry) : null;
            const countryEmoji = activeCountry ? getCountryEmoji(flagCode) : '🌐';
            
            card.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">${countryEmoji}</span>
                        <h2 class="text-xl font-bold">${title}</h2>
                        <span class="bg-dark-secondary px-2 py-1 rounded-full text-xs">${configs.length} configs</span>
                    </div>
                    <button class="btn-sm" onclick="copyConfigsForCountry()">
                        <span class="material-icons">content_copy</span>
                        Copy All
                    </button>
                </div>
                <div class="space-y-3">
                    ${configs.map(config => createConfigItem(config)).join('')}
                </div>
            `;
            
            configsList.appendChild(card);
        }
        
        // Copy configs for country
        function copyConfigsForCountry() {
            const configs = activeCountry ? groupedConfigs[activeCountry] || [] : apiData;
            const configTexts = configs.map(config => config.input_value).join('\n');
            
            navigator.clipboard.writeText(configTexts).then(() => {
                showToast(`Copied ${configs.length} configurations for ${activeCountry || 'all countries'}!`);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy configurations', 'error');
            });
        }
        
        // Filter and display configurations
        function filterAndDisplayConfigs() {
            const searchTerm = searchInput.value.toLowerCase();
            const typeValue = typeFilter.value;
            
            // Filter configs based on search and type
            let filteredConfigs = [];
            
            if (currentCategory === 'all') {
                // Filter from all configs
                filteredConfigs = apiData.filter(config => {
                    // Check if config matches search term
                    const configMatches = searchTerm === '' || 
                        config.input_value.toLowerCase().includes(searchTerm) ||
                        (config.enriched_data && config.enriched_data.new_name && 
                         config.enriched_data.new_name.toLowerCase().includes(searchTerm)) ||
                        (config.country_text && config.country_text.toLowerCase().includes(searchTerm));
                    
                    // Check if config matches type filter
                    const typeMatches = typeValue === 'all' || 
                        (config.enriched_data && config.enriched_data.type === typeValue);
                    
                    return configMatches && typeMatches;
                });
            } else if (currentCategory === 'type' && activeType) {
                // Filter from selected type
                const typeConfigs = groupedByType[activeType] || [];
                filteredConfigs = typeConfigs.filter(config => {
                    // Check if config matches search term
                    const configMatches = searchTerm === '' || 
                        config.input_value.toLowerCase().includes(searchTerm) ||
                        (config.enriched_data && config.enriched_data.new_name && 
                         config.enriched_data.new_name.toLowerCase().includes(searchTerm)) ||
                        (config.country_text && config.country_text.toLowerCase().includes(searchTerm));
                    
                    return configMatches;
                });
            } else if (currentCategory === 'country' && activeCountry) {
                // Filter from selected country
                const countryConfigs = groupedConfigs[activeCountry] || [];
                filteredConfigs = countryConfigs.filter(config => {
                    // Check if config matches search term
                    const configMatches = searchTerm === '' || 
                        config.input_value.toLowerCase().includes(searchTerm) ||
                        (config.enriched_data && config.enriched_data.new_name && 
                         config.enriched_data.new_name.toLowerCase().includes(searchTerm));
                    
                    // Check if config matches type filter
                    const typeMatches = typeValue === 'all' || 
                        (config.enriched_data && config.enriched_data.type === typeValue);
                    
                    return configMatches && typeMatches;
                });
            } else if (currentCategory === 'type-country' && activeType && activeCountry) {
                // Filter from selected type and country
                const typeCountryConfigs = groupedByTypeCountry[activeType]?.[activeCountry] || [];
                filteredConfigs = typeCountryConfigs.filter(config => {
                    // Check if config matches search term
                    const configMatches = searchTerm === '' || 
                        config.input_value.toLowerCase().includes(searchTerm) ||
                        (config.enriched_data && config.enriched_data.new_name && 
                         config.enriched_data.new_name.toLowerCase().includes(searchTerm));
                    
                    return configMatches;
                });
            } else if (currentCategory === 'type-country' && activeType) {
                // Filter from selected type, all countries
                const allCountriesForType = Object.values(groupedByTypeCountry[activeType] || {}).flat();
                filteredConfigs = allCountriesForType.filter(config => {
                    // Check if config matches search term
                    const configMatches = searchTerm === '' || 
                        config.input_value.toLowerCase().includes(searchTerm) ||
                        (config.enriched_data && config.enriched_data.new_name && 
                         config.enriched_data.new_name.toLowerCase().includes(searchTerm)) ||
                        (config.country_text && config.country_text.toLowerCase().includes(searchTerm));
                    
                    return configMatches;
                });
            }
            
            // Display filtered configs
            displayFilteredConfigs(filteredConfigs);
        }
        
        // Display filtered configs
        function displayFilteredConfigs(configs) {
            configsList.innerHTML = '';
            
            if (configs.length === 0) {
                configsList.innerHTML = `
                    <div class="card text-center py-10">
                        <span class="material-icons text-5xl text-dark-muted mb-4">search_off</span>
                        <h3 class="text-xl font-semibold mb-2">No configurations found</h3>
                        <p class="text-dark-muted">Try adjusting your search or filter criteria.</p>
                    </div>
                `;
                return;
            }
            
            // Create a card for the filtered results
            const card = document.createElement('div');
            card.className = 'card animate-fade-in';
            
            const title = currentCategory === 'type' && activeType
                ? `${activeType.toUpperCase()} Configurations`
                : currentCategory === 'country' && activeCountry
                    ? `${activeCountry} Configurations`
                    : currentCategory === 'type-country' && activeType && activeCountry
                        ? `${activeType.toUpperCase()} in ${activeCountry}`
                        : currentCategory === 'type-country' && activeType
                            ? `All ${activeType.toUpperCase()} Configurations`
                            : 'All Configurations';
            
            card.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-3">
                        <h2 class="text-xl font-bold">${title}</h2>
                        <span class="bg-dark-secondary px-2 py-1 rounded-full text-xs">${configs.length} configs</span>
                    </div>
                    <button class="btn-sm" onclick="copyFilteredConfigs()">
                        <span class="material-icons">content_copy</span>
                        Copy All
                    </button>
                </div>
                <div class="space-y-3">
                    ${configs.map(config => createConfigItem(config)).join('')}
                </div>
            `;
            
            configsList.appendChild(card);
        }
        
        // Copy filtered configs
        function copyFilteredConfigs() {
            const configElements = configsList.querySelectorAll('.config-item');
            const configs = Array.from(configElements).map(el => el.dataset.config);
            const configTexts = configs.join('\n');
            
            navigator.clipboard.writeText(configTexts).then(() => {
                showToast(`Copied ${configs.length} configurations!`);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy configurations', 'error');
            });
        }
        
        // Create config item
        function createConfigItem(config) {
            const configName = config.enriched_data && config.enriched_data.new_name 
                ? config.enriched_data.new_name 
                : 'Unnamed Config';
            
            const configType = config.enriched_data && config.enriched_data.type 
                ? config.enriched_data.type.toUpperCase() 
                : 'Unknown';
            
            const configTypeColor = getConfigTypeColor(config.enriched_data && config.enriched_data.type);
            
            return `
                <div class="bg-dark-secondary rounded-lg p-3 flex items-center gap-3 config-item" data-config="${config.input_value}">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="px-2 py-1 rounded text-xs font-medium ${configTypeColor}">${configType}</span>
                            <span class="text-dark-muted text-sm truncate">${configName}</span>
                        </div>
                        <div class="text-xs text-dark-muted font-mono truncate">${config.input_value.substring(0, 60)}${config.input_value.length > 60 ? '...' : ''}</div>
                    </div>
                    <button class="btn-icon" onclick="copyToClipboard('${config.input_value.replace(/'/g, "\\'")}', '${configName.replace(/'/g, "\\'")}')">
                        <span class="material-icons">content_copy</span>
                    </button>
                </div>
            `;
        }
        
        // Get config type color
        function getConfigTypeColor(type) {
            switch(type) {
                case 'vmess': return 'bg-blue-500 text-white';
                case 'vless': return 'bg-green-500 text-white';
                case 'trojan': return 'bg-yellow-500 text-dark-bg';
                case 'ss': return 'bg-purple-500 text-white';
                case 'tuic': return 'bg-pink-500 text-white';
                case 'hy2': return 'bg-red-500 text-white';
                default: return 'bg-gray-500 text-white';
            }
        }
        
        // Get type icon
        function getTypeIcon(type) {
            switch(type) {
                case 'vmess': return 'vpn_lock';
                case 'vless': return 'security';
                case 'trojan': return 'shield';
                case 'ss': return 'lock';
                case 'tuic': return 'speed';
                case 'hy2': return 'bolt';
                default: return 'help_outline';
            }
        }
        
        // Get flag code from country name
        function getFlagCode(country) {
            // Convert country name to proper case (e.g., "united states" -> "United States")
            const properCountry = country.replace(/\w\S*/g, (txt) => 
                txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
            );
            
            // Look up in country codes
            const code = countryCodes[properCountry];
            return code ? code.toLowerCase() : 'un';
        }
        
        // Get country emoji
        function getCountryEmoji(flagCode) {
            if (flagCode === 'cf') return '☁️'; // Cloudflare
            if (flagCode === 'xx' || flagCode === 'un') return '🌐'; // Unknown or UN
            
            // Convert country code to flag emoji
            const codePoints = flagCode
                .toUpperCase()
                .split('')
                .map(char => 127397 + char.charCodeAt(0));
            
            return String.fromCodePoint(...codePoints);
        }
        
        // Copy subscription link
        function copySubscriptionLink() {
            navigator.clipboard.writeText(subscriptionLink).then(() => {
                showToast('Subscription link copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy subscription link', 'error');
            });
        }
        
        // Copy config to clipboard
        function copyToClipboard(text, name) {
            navigator.clipboard.writeText(text).then(() => {
                showToast(`Copied "${name}" to clipboard!`);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy configuration', 'error');
            });
        }
        
        // Show toast notification
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            
            // Update toast styling based on type
            if (type === 'error') {
                toast.className = 'fixed bottom-4 right-4 bg-red-500 text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-2';
                toast.querySelector('.material-icons').textContent = 'error';
            } else {
                toast.className = 'fixed bottom-4 right-4 bg-accent text-dark-bg px-4 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-2';
                toast.querySelector('.material-icons').textContent = 'check_circle';
            }
            
            // Show toast
            setTimeout(() => {
                toast.classList.remove('translate-y-20', 'opacity-0');
            }, 10);
            
            // Hide toast after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }
    </script>
</body>
</html>